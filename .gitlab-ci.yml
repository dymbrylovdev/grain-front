image: docker:latest
services:
  - docker:dind
 
stages:
  - build
  - deploy
  - debug

# jobs for master:
build:
  stage: build
  script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} https://gitlab.magic-egg.net:5005
    - docker build --pull -t $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH .
    - docker push $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH


deploy-dev:
  stage: deploy
  environment: 
    name: "development"
    url: "$DOMEN_MASTER"
  before_script:
    - mkdir -p ~/.ssh
    - echo "$DEV_SERVER_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H $DEV_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - printf "NODE_PATH=src/\n" > web-environment.env
    - scp -r ./web-environment.env $DEV_SERVER_USERNAME@${DEV_SERVER_IP}:~/
    - ssh $DEV_SERVER_USERNAME@$DEV_SERVER_IP "docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} https://gitlab.magic-egg.net:5005; docker stop $CONTAINER_NAME_MASTER; docker rm $CONTAINER_NAME_MASTER --force; docker pull $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH; docker run --restart always -p $PORT_MASTER --name $CONTAINER_NAME_MASTER --env-file web-environment.env -d $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH"

deploy-prod:
  when: manual
  stage: deploy
  environment:
    name: "production"
    url: "https://lk.kupit-zerno.com"
  script:
    - mkdir -p ~/.ssh
    - echo "${PROD_PRIVATE_KEY}" |tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh -t -t -T -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null publisher@lk.kupit-zerno.com "docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} https://gitlab.magic-egg.net:5005 && bash waiter.sh $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH 3080 && docker logout"

safemode-dev:
  stage: debug
  when: manual
  environment: 
    name: "development"
    url: "$DOMEN_DEV"
  variables:
    GIT_STRATEGY: clone
  before_script:
    - mkdir -p ~/.ssh
    - echo "$DEV_SERVER_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H $DEV_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - printf "NODE_PATH=src/\n" > web-environment.env
    - scp -r ./web-environment.env $DEV_SERVER_USERNAME@${DEV_SERVER_IP}:~/
    - ssh $DEV_SERVER_USERNAME@$DEV_SERVER_IP "docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} https://gitlab.magic-egg.net:5005; docker stop $CONTAINER_NAME_MASTER; docker rm $CONTAINER_NAME_MASTER --force; docker pull $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH; docker run --restart always -p $PORT_MASTER --name $CONTAINER_NAME_MASTER --env-file web-environment.env -d $GITLAB_REGISTRIES_URL/$IMAGE_MASTER:$CI_COMMIT_BRANCH"
